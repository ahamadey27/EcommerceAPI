@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card slide-up">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2"></i>Create Account
                    </h3>
                </div>
                <div class="card-body p-4">
                    <div id="alert-container"></div>
                      <form id="register-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">
                                    <i class="fas fa-user me-2"></i>First Name
                                </label>
                                <input type="text" class="form-control" id="firstName" placeholder="John" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="lastName" placeholder="Doe" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-envelope me-2"></i>Email Address
                            </label>
                            <input type="email" class="form-control" id="email" placeholder="john.doe@example.com" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>Password
                            </label>
                            <input type="password" class="form-control" id="password" placeholder="Create a strong password" required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>Password must be at least 6 characters long.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">
                                <i class="fas fa-lock me-2"></i>Confirm Password
                            </label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your password" required>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 mb-3" id="register-btn">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                    </form>
                    
                    <div class="text-center">
                        <p class="mb-0">Already have an account? 
                            <a href="/Login" class="text-decoration-none fw-bold">Login here</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Wait for all scripts to load before setting up the register form
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Register page DOM Content Loaded');
            
            // Function to wait for required functions to be available
            function waitForDependencies() {
                return new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (typeof register === 'function' && typeof API_BASE_URL !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('Register dependencies loaded - API_BASE_URL:', API_BASE_URL);
                            console.log('register function available:', typeof register);
                            resolve();
                        } else {
                            console.log('Waiting for register dependencies... register:', typeof register, 'API_BASE_URL:', typeof API_BASE_URL);
                        }
                    }, 100);
                });
            }
            
            // Initialize the register form once dependencies are ready
            waitForDependencies().then(() => {
                console.log('Setting up register form event listener');
                
                const registerForm = document.getElementById('register-form');
                if (!registerForm) {
                    console.error('Register form not found');
                    return;
                }
                
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Register form submitted');
                    
                    const firstName = document.getElementById('firstName').value;
                    const lastName = document.getElementById('lastName').value;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    console.log('Registration attempt - Email:', email, 'Name:', firstName, lastName);
                    
                    const btn = document.getElementById('register-btn');
                    const spinner = btn.querySelector('.spinner-border');
                    const alertContainer = document.getElementById('alert-container');
                    
                    // Clear previous alerts
                    alertContainer.innerHTML = '';
                    
                    // Validation
                    if (password !== confirmPassword) {
                        alertContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Passwords do not match</div>';
                        return;
                    }
                    
                    if (password.length < 6) {
                        alertContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Password must be at least 6 characters long</div>';
                        return;
                    }
                    
                    // Show loading state
                    btn.disabled = true;
                    spinner.classList.remove('d-none');
                    console.log('Registration loading state activated');
                    
                    try {
                        console.log('Calling register function...');
                        const result = await register(firstName, lastName, email, password, confirmPassword);
                        console.log('Registration result received:', result);
                        
                        if (result && result.success) {
                            console.log('Registration successful, redirecting...');
                            alertContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Registration successful! Redirecting...</div>';
                            setTimeout(() => {
                                console.log('Redirecting to /Products');
                                window.location.href = '/Products';
                            }, 1500);
                        } else {
                            const errorMsg = result?.error || 'Registration failed';
                            console.log('Registration failed:', errorMsg);
                            alertContainer.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${errorMsg}</div>`;
                        }
                    } catch (error) {
                        console.error('Registration error caught:', error);
                        alertContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Registration failed. Please try again.</div>';
                    } finally {
                        // Reset loading state
                        btn.disabled = false;
                        spinner.classList.add('d-none');
                        console.log('Registration loading state cleared');
                    }
                });
                
                console.log('Register form event listener attached successfully');
            });
        });
    </script>
}
